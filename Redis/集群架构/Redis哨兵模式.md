## 1 哨兵模式简介
> 哨兵本身也是一个独立的进程，可以独立运行，不提供读写服务，而是专注于监控和故障转移任务

- Redis 的哨兵模式（Sentinel）是一种用于实现高可用性的解决方案，它可以监控 Redis 实例的状态，并在主节点发生故障时自动将从节点提升为新的主节点，从而实现故障转移。
- 哨兵模式通过以下几个关键功能来实现高可用性：
  - **集群监控**：哨兵会持续监控主节点（Master）和从节点（Slave）的状态，确保它们都在正常运行。
  - **故障检测**：当哨兵检测到主节点出现故障时，会触发故障转移机制。它通过多个哨兵之间的通信和投票来确认故障，这个过程涉及到主观下线（sdown）和客观下线（odown）的概念。
  - **自动故障转移**：一旦主节点被确认为客观下线，哨兵会开始故障转移过程。它会从健康的从节点中选举出一个新的主节点，并将其余的从节点指向新的主节点。
  - **配置更新与通知**：故障转移完成后，哨兵会更新相关的配置，并通知客户端新的主节点地址，确保客户端可以连接到新的主节点并继续操作。
  - **通知系统**：哨兵使用 Redis 的发布/订阅机制来发布关于故障转移和主从切换的事件，客户端可以订阅这些事件来获取通知。
![哨兵模式](../images/%E5%93%A8%E5%85%B5%E6%A8%A1%E5%BC%8F.png)

## 2 哨兵模式工作方式
  1) **监控**：哨兵（Sentinel）进程会定期向所有运行中的 Redis 实例（包括主节点和从节点）发送 PING 命令，以检测它们是否仍然在线。

  2) **主观下线（Subjectively Down, SDOWN）**：当哨兵检测到主节点没有响应时，它会认为主节点是主观下线状态，这是哨兵个体对主节点状态的判断。

  3) **客观下线（Objectively Down, ODOWN）**：为了确认主节点是否真正下线，哨兵会询问其他哨兵节点对主节点的状态看法。如果大多数哨兵都同意主节点不可用，即达到客观下线状态，这时会触发故障转移机制。

  4) **领导者选举**：哨兵之间会进行领导者选举，以决定哪个哨兵负责执行故障转移操作。选举过程考虑了哨兵的优先级和复制偏移量等因素。

  5) **故障转移**：领导者哨兵执行故障转移操作，领导者哨兵会通过选举算法（通常是Raft或Paxos）确定一个从节点作为新的主节点。它将执行以下操作：
     - 将选定的从节点配置更新，使其不再复制原主节点。
     - 更新其他从节点的配置，让它们开始复制新的主节点。
     - 通过发布订阅模式，通知所有哨兵和客户端新的主节点信息。

  6) **配置传播**：新的主节点信息被传播到所有哨兵和客户端，确保系统更新操作指向新的主节点。

  7) **原主节点恢复**：如果原主节点之后恢复上线，它会被自动配置为新主节点的从节点，以避免数据丢失并保持数据一致性。

整个故障转移过程是自动执行的，不需要人工干预，从而实现高可用性。哨兵模式通过这些步骤确保了 Redis 在面临主节点故障时的鲁棒性，提高了系统的稳定性和可靠性。

## 3 哨兵模式的优缺点
Redis 哨兵模式（Sentinel）的优点和缺点如下：

### 3.1 优点：

  1. **自动故障转移**：哨兵模式能够自动检测主节点故障并执行故障转移，无需人工干预，提高了系统的可用性。

  2. **数据安全性**：通过监控主从节点，哨兵模式有助于保障数据的安全性和稳定性。

  3. **读写分离**：哨兵模式支持读写分离，可以提高读操作的性能。

  4. **灵活的配置**：哨兵模式提供多种配置选项，如从节点的优先级、故障转移的超时时间等，可以根据实际需求进行灵活调整。

  5. **可扩展性**：通过增加哨兵节点，可以扩展哨兵集群的容量和性能。

  6. **高可用性**：哨兵模式通过自动故障转移机制，确保了Redis服务的高可用性，尤其适用于对数据稳定性要求高的场景。

### 3.2 缺点：

  1. **延迟问题**：哨兵进行频繁的状态检查和故障转移操作可能会对系统带来一定的延迟。

  2. **复杂性增加**：引入哨兵模式后，需要对集群进行额外的配置和管理，增加了系统的复杂度。

  3. **有限的故障转移能力**：哨兵模式主要针对主节点故障转移，如果从节点发生故障，哨兵不会执行故障转移。

  4. **资源消耗**：运行哨兵节点需要额外的资源，因为每个哨兵节点都是独立的进程。

  5. **配置和部署的复杂性**：需要正确配置哨兵节点，以及进行适当的监控和测试，以确保故障转移流程能够正常工作。

  6. **对客户端的影响**：故障转移期间，客户端可能需要重新连接到新的主节点，这要求客户端能够处理重连逻辑。

  7. **数据一致性**：在故障转移期间，可能会出现短暂的数据不一致情况，尤其是在高负载下。

  8. **最小实例要求**：为了保证哨兵系统的鲁棒性，通常建议至少部署三个哨兵实例，这在资源有限的环境中可能不现实。